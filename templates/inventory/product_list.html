<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Produits - PharmaGestion</title>

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Custom Design System -->
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">

    <style>
        .products-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: var(--spacing-lg);
        }

        .products-header {
            background: linear-gradient(135deg, var(--color-primary), var(--color-info));
            padding: var(--spacing-xl);
            border-radius: var(--radius-xl);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-xl), var(--shadow-glow-primary);
        }

        .products-header h1 {
            margin: 0;
            color: white;
            font-size: var(--text-3xl);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .action-buttons {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
            flex-wrap: wrap;
        }

        .messages {
            margin-bottom: var(--spacing-lg);
        }

        .alert {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert-success {
            border-left: 4px solid var(--color-success);
        }

        .alert-warning {
            border-left: 4px solid var(--color-warning);
        }

        .alert-danger {
            border-left: 4px solid var(--color-danger);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }
    </style>
</head>

<body>
    <div class="products-container">
        <!-- Header -->
        <div class="products-header">
            <h1>
                <i class="bi bi-capsule"></i>
                Gestion des Produits
            </h1>
            <div class="action-buttons">
                <a href="/inventory/dashboard/" class="btn-gradient btn-primary">
                    <i class="bi bi-clipboard-data"></i> Tableau de Bord
                </a>
                <a href="/" class="btn-gradient btn-success">
                    <i class="bi bi-cash-coin"></i> Caisse
                </a>
                <a href="{% url 'receive_stock' %}" class="btn-gradient btn-warning">
                    <i class="bi bi-truck"></i> RÃ©ceptionner Stock
                </a>
                <a href="{% url 'product_add' %}" class="btn-gradient btn-success">
                    <i class="bi bi-plus-circle"></i> Nouveau Produit
                </a>
                <!-- Export / Import buttons -->
                <a href="{% url 'export_products_excel' %}" class="btn-gradient btn-outline" style="background: transparent; border: 1px dashed rgba(255,255,255,0.12); color: white;">
                    <i class="bi bi-download"></i> Exporter (Excel)
                </a>

                <a href="{% url 'download_products_template' %}" class="btn-gradient btn-outline" style="background: transparent; border: 1px dashed rgba(255,255,255,0.12); color: white;">
                    <i class="bi bi-file-earmark-spreadsheet"></i> ModÃ¨le Excel
                </a>

                <form id="import-form" action="{% url 'import_products_excel' %}" method="post" enctype="multipart/form-data" style="display:inline-block; margin:0;">
                    {% csrf_token %}
                    <label for="import_file" class="btn-gradient btn-info" style="cursor: pointer;">
                        <i class="bi bi-upload"></i> Importer (Excel)
                    </label>
                    <input id="import_file" type="file" name="file" accept=".xlsx,.xls" style="display:none;" />
                </form>
            </div>
        </div>

        <!-- Messages -->
        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                <span>{{ message }}</span>
                <button class="close-btn" onclick="this.parentElement.remove()">Ã—</button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Products Table -->
        <div class="glass-card glass-card-lg">
            <h3 style="margin-bottom: var(--spacing-lg);">
                <i class="bi bi-list-ul"></i> Liste des Produits
            </h3>

            <div class="table-container">
                <table class="table-glass">
                    <thead>
                        <tr>
                            <th>Produit</th>
                            <th>DCI</th>
                            <th>Classe</th>
                            <th>Stock</th>
                            <th>Prix Achat</th>
                            <th>Prix Vente</th>
                            <th>Marge</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in products %}
                        <tr>
                            <td>
                                <strong>{{ product.name }}</strong>
                                {% if product.current_stock == 0 %}
                                <span class="badge-glow badge-danger"
                                    style="margin-left: var(--spacing-sm);">Rupture</span>
                                {% elif product.current_stock <= product.minimum_stock_level %} <span
                                    class="badge-glow badge-warning" style="margin-left: var(--spacing-sm);">
                                    Faible</span>
                                    {% endif %}
                            </td>
                            <td>{{ product.dci|default:"-" }}</td>
                            <td>{{ product.get_therapeutic_class_display }}</td>
                            <td>
                                {{ product.current_stock }}
                                <small style="color: var(--text-muted);">/ {{ product.minimum_stock_level }} min</small>
                            </td>
                            <td>{{ product.cost_price }} FCFA</td>
                            <td>{{ product.selling_price }} FCFA</td>
                            <td>
                                {% widthratio product.profit_margin 1 1 as margin %}
                                <span class="badge-glow" {% if margin > 30 %}class="badge-success"
                                    {% elif margin > 15 %}class="badge-warning"
                                    {% else %}class="badge-danger"{% endif %}
                                    >
                                    {{ margin }}%
                                </span>
                            </td>
                            <td>
                                <div style="display: flex; gap: var(--spacing-sm);">
                                    <a href="{% url 'receive_stock_product' product.id %}"
                                        style="padding: 0.375rem 0.75rem; background: linear-gradient(135deg, var(--color-warning), var(--color-warning-light)); border-radius: var(--radius-sm); color: white; text-decoration: none; transition: all var(--transition-base);"
                                        title="RÃ©ceptionner stock">
                                        <i class="bi bi-truck"></i>
                                    </a>
                                    <a href="{% url 'adjust_stock' product.id %}"
                                        style="padding: 0.375rem 0.75rem; background: var(--bg-tertiary); border: 1px solid var(--glass-border); border-radius: var(--radius-sm); color: var(--text-primary); text-decoration: none; transition: all var(--transition-base);"
                                        title="Ajuster stock">
                                        <i class="bi bi-sliders"></i>
                                    </a>
                                    <a href="{% url 'product_edit' product.id %}"
                                        style="padding: 0.375rem 0.75rem; background: linear-gradient(135deg, var(--color-primary), var(--color-primary-light)); border-radius: var(--radius-sm); color: white; text-decoration: none; transition: all var(--transition-base);"
                                        title="Modifier">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8"
                                style="text-align: center; padding: var(--spacing-2xl); color: var(--text-muted);">
                                <i class="bi bi-inbox"
                                    style="font-size: 4rem; opacity: 0.3; display: block; margin-bottom: var(--spacing-md);"></i>
                                <h5 style="margin-top: var(--spacing-md);">Aucun produit trouvÃ©</h5>
                                <a href="{% url 'product_add' %}" class="btn-gradient btn-primary"
                                    style="margin-top: var(--spacing-md); display: inline-flex; align-items: center; gap: 0.5rem;">
                                    <i class="bi bi-plus-circle"></i> Ajouter le premier produit
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer
        style="margin-top: var(--spacing-2xl); padding: var(--spacing-lg); text-align: center; border-top: 1px solid var(--glass-border);">
        <small style="color: var(--text-secondary);">
            Un produit <strong style="color: var(--color-primary);">HydaraSoft</strong> |
            DÃ©veloppÃ© par <strong>Ismail HAIDARA</strong> |
            ðŸ“ž <a href="tel:+22391550337">00223 91550337</a> |
            ðŸ“§ <a href="mailto:ihaidara852@gmail.com">ihaidara852@gmail.com</a>
        </small>
    </footer>

    <!-- Scripts -->
    <script src="{% static 'js/animations.js' %}"></script>
    <script src="/static/js/offline-sales.js"></script>
    <script src="/static/js/offline-data-loader.js"></script>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/js/service-worker.js');
        }

        if (navigator.onLine && window.offlineDataLoader) {
            window.offlineDataLoader.loadAllData();
        }
    </script>
    <script>
        // Client-side validation for import file
        (function(){
            const input = document.getElementById('import_file');
            const form = document.getElementById('import-form');
            if (!input || !form) return;

            const MAX_BYTES = 5 * 1024 * 1024; // 5MB
            input.addEventListener('change', function(e){
                const file = input.files[0];
                if (!file) return;
                const name = file.name.toLowerCase();
                if (!(name.endsWith('.xlsx') || name.endsWith('.xls'))) {
                    alert('Veuillez sÃ©lectionner un fichier Excel (.xlsx ou .xls).');
                    input.value = '';
                    return;
                }
                if (file.size > MAX_BYTES) {
                    alert('Le fichier est trop volumineux. Taille maximale: 5MB.');
                    input.value = '';
                    return;
                }
                // all good, submit
                form.submit();
            });
        })();
    </script>
</body>

</html>