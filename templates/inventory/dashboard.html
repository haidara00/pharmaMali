<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PharmaGestion - Tableau de Bord Inventaire</title>

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Custom Design System -->
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">

    <!-- Alpine.js -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

    <style>
        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: var(--spacing-lg);
        }

        .dashboard-header {
            background: linear-gradient(135deg, var(--color-primary), var(--color-info));
            padding: var(--spacing-xl);
            border-radius: var(--radius-xl);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-xl), var(--shadow-glow-primary);
        }

        .dashboard-header h1 {
            margin: 0;
            color: white;
            font-size: var(--text-3xl);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .nav-pills {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
            flex-wrap: wrap;
        }

        .nav-pill {
            padding: 0.625rem 1.25rem;
            border-radius: var(--radius-lg);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            transition: all var(--transition-base);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-pill:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            color: white;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .alerts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .alert-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            max-height: 400px;
            overflow-y: auto;
        }

        .alert-card h3 {
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .alert-item {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid;
            transition: all var(--transition-fast);
        }

        .alert-item:hover {
            transform: translateX(4px);
        }

        .alert-item.danger {
            border-left-color: var(--color-danger);
        }

        .alert-item.warning {
            border-left-color: var(--color-warning);
        }

        .products-section {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .refresh-btn {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-light));
            border: none;
            border-radius: var(--radius-md);
            color: white;
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .refresh-btn.spinning i {
            animation: spin 1s linear infinite;
        }

        .table-container {
            overflow-x: auto;
        }

        .no-alerts {
            text-align: center;
            padding: var(--spacing-2xl);
            color: var(--text-secondary);
        }

        .no-alerts i {
            font-size: 4rem;
            color: var(--color-success);
            margin-bottom: var(--spacing-md);
        }
    </style>
</head>

<body>
    <div class="dashboard-container" x-data="inventoryDashboard()">
        <!-- Header -->
        <div class="dashboard-header">
            <h1>
                <i class="bi bi-clipboard-data"></i>
                Tableau de Bord Inventaire
            </h1>
            <div class="nav-pills">
                {# Suppliers and Purchase Orders removed from navigation #}
                <a href="/inventory/products/" class="nav-pill">
                    <i class="bi bi-capsule"></i> Produits
                </a>
                <a href="/" class="nav-pill">
                    <i class="bi bi-cash-coin"></i> Caisse
                </a>
                <a href="/inventory/analytics/" class="nav-pill">
                    <i class="bi bi-graph-up"></i> Analytics
                </a>
            </div>
        </div>

        <!-- Metrics Cards -->
        <div class="metrics-grid">
            <div class="metric-card metric-card-primary">
                <div class="icon">
                    <i class="bi bi-box-seam"></i>
                </div>
                <div class="value" x-text="metrics.total_products">0</div>
                <div class="label">Produits Total</div>
            </div>

            <div class="metric-card metric-card-success">
                <div class="icon">
                    <i class="bi bi-currency-exchange"></i>
                </div>
                <div class="value" x-text="formatPrice(metrics.total_stock_value)">0 FCFA</div>
                <div class="label">Valeur du Stock</div>
            </div>

            <div class="metric-card metric-card-danger"
                :class="{ 'metric-card-pulse': metrics.out_of_stock_count > 0 }">
                <div class="icon">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <div class="value" x-text="metrics.out_of_stock_count">0</div>
                <div class="label">Ruptures de Stock</div>
            </div>

            <div class="metric-card metric-card-warning" :class="{ 'metric-card-pulse': metrics.low_stock_count > 0 }">
                <div class="icon">
                    <i class="bi bi-exclamation-circle"></i>
                </div>
                <div class="value" x-text="metrics.low_stock_count">0</div>
                <div class="label">Stocks Faibles</div>
            </div>

            <div class="metric-card metric-card-warning"
                :class="{ 'metric-card-pulse': metrics.critical_expiry_count > 0 }">
                <div class="icon">
                    <i class="bi bi-calendar-x"></i>
                </div>
                <div class="value" x-text="metrics.critical_expiry_count">0</div>
                <div class="label">Expirations Critiques</div>
            </div>

            <div class="metric-card metric-card-danger" :class="{ 'metric-card-pulse': metrics.expired_count > 0 }">
                <div class="icon">
                    <i class="bi bi-calendar-event"></i>
                </div>
                <div class="value" x-text="metrics.expired_count">0</div>
                <div class="label">Produits Expir√©s</div>
            </div>
        </div>

        <!-- Alerts Section -->
        <div x-show="hasAlerts" style="display: none;">
            <div class="alerts-grid">
                <!-- Out of Stock Alerts -->
                <div x-show="alerts.out_of_stock.length > 0" class="alert-card">
                    <h3 style="color: var(--color-danger);">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        Ruptures de Stock
                    </h3>
                    <template x-for="product in alerts.out_of_stock" :key="product.name">
                        <div class="alert-item danger">
                            <span x-text="product.name"></span>
                            <span class="badge-glow badge-danger">Stock: <span
                                    x-text="product.current_stock"></span></span>
                        </div>
                    </template>
                </div>

                <!-- Low Stock Alerts -->
                <div x-show="alerts.low_stock.length > 0" class="alert-card">
                    <h3 style="color: var(--color-warning);">
                        <i class="bi bi-exclamation-circle-fill"></i>
                        Stocks Faibles
                    </h3>
                    <template x-for="product in alerts.low_stock" :key="product.name">
                        <div class="alert-item warning">
                            <span x-text="product.name"></span>
                            <small style="color: var(--text-secondary);">
                                Stock: <strong x-text="product.current_stock"></strong> /
                                Min: <strong x-text="product.minimum_stock"></strong>
                            </small>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- No Alerts Message -->
        <div x-show="!hasAlerts && !loading" class="glass-card glass-card-lg no-alerts" style="display: none;">
            <i class="bi bi-check-circle"></i>
            <h4>Aucune alerte pour le moment</h4>
            <p style="color: var(--text-muted);">Tous les stocks sont √† des niveaux acceptables</p>
        </div>

        <!-- Products Table -->
        <div class="products-section">
            <div class="section-header">
                <h3 style="margin: 0;">
                    <i class="bi bi-list-ul"></i> Inventaire des Produits
                </h3>
                <button class="refresh-btn" @click="loadData()" :class="{ 'spinning': loading }">
                    <i class="bi bi-arrow-clockwise"></i> Actualiser
                </button>
            </div>

            <!-- Loading State -->
            <div x-show="loading" style="text-align: center; padding: var(--spacing-2xl);">
                <div class="spinner"></div>
            </div>

            <!-- Products Table -->
            <div x-show="!loading" class="table-container" style="display: none;">
                <table class="table-glass">
                    <thead>
                        <tr>
                            <th>Produit</th>
                            <th>DCI</th>
                            <th>Classe</th>
                            <th>Stock</th>
                            <th>Statut</th>
                            <th>Prix Vente</th>
                            <th>Prix Co√ªt</th>
                            <th>Valeur</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="product in products" :key="product.id">
                            <tr>
                                <td><strong x-text="product.name"></strong></td>
                                <td x-text="product.dci || '-'"></td>
                                <td x-text="product.therapeutic_class"></td>
                                <td>
                                    <span x-text="product.current_stock"></span>
                                    <small style="color: var(--text-muted);"
                                        x-text="'/ ' + product.minimum_stock_level"></small>
                                </td>
                                <td>
                                    <span class="badge-glow" :class="{
                                            'badge-danger': product.stock_status === 'out_of_stock',
                                            'badge-warning': product.stock_status === 'low_stock',
                                            'badge-success': product.stock_status === 'in_stock'
                                        }" x-text="product.stock_status_display"></span>
                                </td>
                                <td x-text="formatPrice(product.selling_price)"></td>
                                <td x-text="formatPrice(product.cost_price)"></td>
                                <td><strong x-text="formatPrice(product.total_value)"></strong></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- Empty State -->
            <div x-show="!loading && products.length === 0"
                style="text-align: center; padding: var(--spacing-2xl); color: var(--text-muted);">
                <i class="bi bi-inbox" style="font-size: 4rem; opacity: 0.3;"></i>
                <h5 style="margin-top: var(--spacing-md);">Aucun produit trouv√©</h5>
                <p>Ajoutez des produits dans l'interface d'administration pour commencer</p>
                <a href="/admin/inventory/product/add/" class="btn-gradient btn-primary"
                    style="margin-top: var(--spacing-md); display: inline-flex; align-items: center; gap: 0.5rem;">
                    <i class="bi bi-plus-circle"></i> Ajouter un Produit
                </a>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer
        style="margin-top: var(--spacing-2xl); padding: var(--spacing-lg); text-align: center; border-top: 1px solid var(--glass-border);">
        <small style="color: var(--text-secondary);">
            Un produit <strong style="color: var(--color-primary);">HydaraSoft</strong> |
            D√©velopp√© par <strong>Ismail HAIDARA</strong> |
            üìû <a href="tel:+22391550337">00223 91550337</a> |
            üìß <a href="mailto:ihaidara852@gmail.com">ihaidara852@gmail.com</a>
        </small>
    </footer>

    <!-- Scripts -->
    <script src="{% static 'js/animations.js' %}"></script>
    <script src="/static/js/offline-sales.js"></script>
    <script src="/static/js/offline-data-loader.js"></script>

    <script>
        function inventoryDashboard() {
            return {
                loading: true,
                metrics: {
                    total_products: 0,
                    total_stock_value: 0,
                    low_stock_count: 0,
                    out_of_stock_count: 0,
                    critical_expiry_count: 0,
                    expired_count: 0
                },
                alerts: {
                    low_stock: [],
                    out_of_stock: []
                },
                products: [],

                get hasAlerts() {
                    return this.alerts.out_of_stock.length > 0 || this.alerts.low_stock.length > 0;
                },

                async init() {
                    await this.loadData();
                    // Auto-refresh every 5 minutes
                    setInterval(() => {
                        this.loadData();
                    }, 300000);

                    // Animate metric values on load
                    this.$nextTick(() => {
                        this.animateMetrics();
                    });
                },

                async loadData() {
                    this.loading = true;
                    try {
                        const response = await fetch('/inventory/api/dashboard/');
                        const data = await response.json();

                        this.metrics = data.metrics;
                        this.alerts = data.alerts;
                        this.products = data.products;

                        this.$nextTick(() => {
                            this.animateMetrics();
                        });
                    } catch (error) {
                        console.error('Error loading dashboard data:', error);
                        window.pharmaAnimations.showToast('Erreur lors du chargement des donn√©es', 'danger');
                    } finally {
                        this.loading = false;
                    }
                },

                animateMetrics() {
                    // Animate the metric values with count-up effect
                    const valueElements = document.querySelectorAll('.metric-card .value');
                    valueElements.forEach(el => {
                        const text = el.textContent;
                        // Only animate if it's a number
                        if (!isNaN(parseInt(text))) {
                            const endValue = parseInt(text);
                            window.pharmaAnimations.countUp(el, endValue, 1000);
                        }
                    });
                },

                formatPrice(price) {
                    return new Intl.NumberFormat('fr-FR', {
                        style: 'currency',
                        currency: 'XOF',
                        minimumFractionDigits: 0
                    }).format(price);
                }
            }
        }
    </script>

    <!-- Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/js/service-worker.js')
                .then(() => console.log('‚úÖ Service Worker registered'))
                .catch(err => console.log('‚ùå Service Worker failed:', err));
        }

        // Offline data loader
        if (navigator.onLine && window.offlineDataLoader) {
            window.offlineDataLoader.loadAllData();
        }
    </script>
</body>

</html>