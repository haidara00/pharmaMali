<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PharmaGestion - Caisse</title>

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Custom Design System -->
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">

    <!-- Alpine.js for reactivity -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

    <!-- QuaggaJS for barcode scanning -->
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

    <style>
        /* POS-specific styles */
        .pos-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: var(--spacing-lg);
        }

        .pos-header {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-light));
            padding: var(--spacing-xl);
            border-radius: var(--radius-xl);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-xl), var(--shadow-glow-primary);
        }

        .pos-header h1 {
            margin: 0;
            color: white;
            font-size: var(--text-3xl);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .nav-pills {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
            flex-wrap: wrap;
        }

        .nav-pill {
            padding: 0.625rem 1.25rem;
            border-radius: var(--radius-lg);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            transition: all var(--transition-base);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-pill:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            color: white;
        }

        .pos-grid {
            display: grid;
            grid-template-columns: 1fr 450px;
            gap: var(--spacing-xl);
        }

        .search-section {
            margin-bottom: var(--spacing-lg);
        }

        .search-input-wrapper {
            position: relative;
            margin-bottom: var(--spacing-md);
        }

        .search-input-wrapper i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1.25rem;
        }

        .search-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 2px solid var(--glass-border);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            font-size: var(--text-lg);
            transition: all var(--transition-base);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 4px hsla(var(--primary-hue), var(--primary-sat), var(--primary-light), 0.2);
        }

        .barcode-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--color-success), var(--color-success-light));
            border: none;
            border-radius: var(--radius-lg);
            color: white;
            font-weight: 600;
            font-size: var(--text-base);
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .barcode-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg), var(--shadow-glow-success);
        }

        .product-result {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .product-result:hover {
            transform: translateX(4px);
            border-color: var(--color-primary);
            box-shadow: var(--shadow-md);
        }

        .product-result.out-of-stock {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .product-result.low-stock {
            border-left: 4px solid var(--color-warning);
        }

        .cart-section {
            position: sticky;
            top: var(--spacing-lg);
        }

        .cart-header {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            padding: var(--spacing-lg);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            border: 1px solid var(--glass-border);
            border-bottom: none;
        }

        .cart-body {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-top: none;
            border-bottom: none;
            padding: var(--spacing-md);
            max-height: 400px;
            overflow-y: auto;
        }

        .cart-item {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            border: 1px solid var(--glass-border);
            transition: all var(--transition-fast);
            animation: slideInRight 0.3s ease-out;
        }

        .cart-item:hover {
            background: var(--bg-tertiary);
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .quantity-btn {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--glass-border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .quantity-btn:hover {
            background: var(--color-primary);
            border-color: var(--color-primary);
        }

        .cart-footer {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            padding: var(--spacing-lg);
            border-radius: 0 0 var(--radius-xl) var(--radius-xl);
            border: 1px solid var(--glass-border);
            border-top: 2px solid var(--color-primary);
        }

        .total-amount {
            font-size: var(--text-3xl);
            font-weight: 700;
            font-family: var(--font-display);
            background: linear-gradient(135deg, var(--color-success), var(--color-success-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .payment-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        .empty-cart {
            text-align: center;
            padding: var(--spacing-2xl);
            color: var(--text-muted);
        }

        .empty-cart i {
            font-size: 4rem;
            margin-bottom: var(--spacing-md);
            opacity: 0.3;
        }

        @media (max-width: 1024px) {
            .pos-grid {
                grid-template-columns: 1fr;
            }

            .cart-section {
                position: static;
            }
        }

        @media (max-width: 768px) {
            .payment-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="pos-container" x-data="posApp()">
        <!-- Header -->
        <div class="pos-header">
            <h1>
                <i class="bi bi-cash-coin"></i>
                Point de Vente
            </h1>
            <div class="nav-pills">
                <a href="/sales-history/" class="nav-pill">
                    <i class="bi bi-clock-history"></i> Historique
                </a>
                <a href="/credit-ledger/" class="nav-pill">
                    <i class="bi bi-credit-card"></i> Cr√©dits
                </a>
                <a href="/inventory/dashboard/" class="nav-pill">
                    <i class="bi bi-box-seam"></i> Inventaire
                </a>
            </div>
        </div>

        <!-- Main POS Grid -->
        <div class="pos-grid">
            <!-- Left: Search & Results -->
            <div>
                <!-- Search Section -->
                <div class="glass-card glass-card-md search-section">
                    <div class="search-input-wrapper">
                        <i class="bi bi-search"></i>
                        <input type="text" class="search-input" placeholder="Rechercher un m√©dicament..."
                            x-model="searchQuery" @input.debounce.300ms="searchProducts()"
                            @keyup.enter="addFirstResult()">
                    </div>

                    <button class="barcode-btn" @click="startScanner()">
                        <i class="bi bi-upc-scan"></i>
                        Scanner Code-barres
                    </button>
                </div>

                <!-- Search Results -->
                <div x-show="searchResults.length > 0" style="display: none;">
                    <div style="margin-bottom: var(--spacing-sm); color: var(--text-secondary);">
                        <i class="bi bi-search"></i> <span x-text="searchResults.length"></span> r√©sultat(s)
                    </div>

                    <template x-for="product in searchResults" :key="product.id">
                        <div class="product-result" :class="{
                                'out-of-stock': product.current_stock === 0,
                                'low-stock': product.current_stock > 0 && product.current_stock <= product.minimum_stock_level
                            }" @click="addToCart(product)">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 0.25rem;" x-text="product.name"></div>
                                    <div x-show="product.dci"
                                        style="font-size: var(--text-sm); color: var(--text-secondary);"
                                        x-text="product.dci"></div>
                                    <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        <span class="badge-glow" :class="{
                                                'badge-danger': product.current_stock === 0,
                                                'badge-warning': product.current_stock > 0 && product.current_stock <= product.minimum_stock_level,
                                                'badge-success': product.current_stock > product.minimum_stock_level
                                            }"
                                            x-text="product.current_stock === 0 ? 'Rupture' : `Stock: ${product.current_stock}`"></span>
                                        <span x-show="product.barcode" class="badge-glow badge-primary">
                                            <i class="bi bi-upc"></i> <span x-text="product.barcode"></span>
                                        </span>
                                    </div>
                                </div>
                                <div style="text-align: right; margin-left: var(--spacing-md);">
                                    <div style="font-size: var(--text-xl); font-weight: 700; font-family: var(--font-display);"
                                        x-text="formatPrice(product.price)"></div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Right: Cart -->
            <div class="cart-section">
                <div class="cart-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="bi bi-cart3"></i>
                            Panier
                            <span class="badge-glow badge-primary" x-text="cart.length"></span>
                        </h3>
                        <button @click="clearCart()" :disabled="cart.length === 0"
                            style="padding: 0.5rem 1rem; background: var(--color-danger); border: none; border-radius: var(--radius-md); color: white; cursor: pointer; transition: all var(--transition-fast);"
                            :style="cart.length === 0 ? 'opacity: 0.5; cursor: not-allowed;' : ''">
                            <i class="bi bi-trash"></i> Vider
                        </button>
                    </div>
                </div>

                <div class="cart-body">
                    <div x-show="cart.length === 0" class="empty-cart">
                        <i class="bi bi-cart-x"></i>
                        <p>Panier vide</p>
                        <small>Recherchez ou scannez des produits</small>
                    </div>

                    <template x-for="item in cart" :key="item.id">
                        <div class="cart-item">
                            <div
                                style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-sm);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600;" x-text="item.name"></div>
                                    <div style="font-size: var(--text-sm); color: var(--text-secondary);"
                                        x-text="formatPrice(item.price)"></div>
                                </div>
                                <button @click="removeFromCart(item)"
                                    style="background: none; border: none; color: var(--color-danger); cursor: pointer; font-size: 1.5rem; padding: 0; line-height: 1;">
                                    √ó
                                </button>
                            </div>

                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div class="quantity-controls">
                                    <button class="quantity-btn" @click="decrementQuantity(item)">‚àí</button>
                                    <span style="min-width: 40px; text-align: center; font-weight: 600;"
                                        x-text="item.quantity"></span>
                                    <button class="quantity-btn" @click="incrementQuantity(item)">+</button>
                                </div>
                                <div style="font-weight: 700; font-size: var(--text-lg);"
                                    x-text="formatPrice(item.price * item.quantity)"></div>
                            </div>
                        </div>
                    </template>
                </div>

                <div class="cart-footer">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                        <span style="font-size: var(--text-lg); color: var(--text-secondary);">Total:</span>
                        <span class="total-amount" x-text="formatPrice(total)"></span>
                    </div>

                    <div class="payment-buttons">
                        <button class="btn-gradient btn-success" :disabled="cart.length === 0"
                            @click="completeSale('paid')"
                            :style="cart.length === 0 ? 'opacity: 0.5; cursor: not-allowed;' : ''">
                            <i class="bi bi-cash"></i> Comptant
                        </button>
                        <button class="btn-gradient btn-warning" :disabled="cart.length === 0"
                            @click="completeSale('credit')"
                            :style="cart.length === 0 ? 'opacity: 0.5; cursor: not-allowed;' : ''">
                            <i class="bi bi-clock"></i> Cr√©dit
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Barcode Scanner Modal -->
        <div x-show="showScanner" class="modal-overlay" style="display: none;" @click.self="stopScanner()">
            <div class="modal-content">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
                    <h3 style="margin: 0;"><i class="bi bi-upc-scan"></i> Scanner Code-barres</h3>
                    <button @click="stopScanner()"
                        style="background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--text-primary);">√ó</button>
                </div>

                <div class="scanner-container" style="height: 300px;">
                    <div id="barcode-scanner" style="width: 100%; height: 100%;"></div>
                </div>

                <div x-show="scannerError"
                    style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: var(--color-danger); border-radius: var(--radius-md); color: white;">
                    <i class="bi bi-exclamation-triangle"></i> <span x-text="scannerError"></span>
                </div>

                <div style="margin-top: var(--spacing-lg); text-align: center; color: var(--text-secondary);">
                    <i class="bi bi-info-circle"></i> Placez le code-barres dans le cadre
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer
        style="margin-top: var(--spacing-2xl); padding: var(--spacing-lg); text-align: center; border-top: 1px solid var(--glass-border);">
        <small style="color: var(--text-secondary);">
            Un produit <strong style="color: var(--color-primary);">HydaraSoft</strong> |
            D√©velopp√© par <strong>Ismail HAIDARA</strong> |
            üìû <a href="tel:+22391550337">00223 91550337</a> |
            üìß <a href="mailto:ihaidara852@gmail.com">ihaidara852@gmail.com</a>
        </small>
    </footer>

    <!-- Scripts -->
    <script src="{% static 'js/animations.js' %}"></script>
    <script src="/static/js/offline-sales.js"></script>

    <script>
        function posApp() {
            return {
                searchQuery: '',
                searchResults: [],
                cart: [],
                showScanner: false,
                scannerError: '',
                isScanning: false,

                get total() {
                    return this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                },

                async searchProducts() {
                    if (this.searchQuery.length < 2) {
                        this.searchResults = [];
                        return;
                    }

                    try {
                        const response = await fetch(`/api/products/search/?q=${encodeURIComponent(this.searchQuery)}`);
                        this.searchResults = await response.json();
                    } catch (error) {
                        console.error('Search error:', error);
                        this.searchResults = [];
                    }
                },

                addFirstResult() {
                    if (this.searchResults.length > 0) {
                        this.addToCart(this.searchResults[0]);
                    }
                },

                addToCart(product) {
                    if (product.current_stock === 0) {
                        window.pharmaAnimations.showToast(`${product.name} est en rupture de stock!`, 'danger');
                        return;
                    }

                    const existingItem = this.cart.find(item => item.id === product.id);
                    const currentQuantityInCart = existingItem ? existingItem.quantity : 0;

                    if (currentQuantityInCart >= product.current_stock) {
                        window.pharmaAnimations.showToast(`Stock insuffisant! Il reste ${product.current_stock} unit√©s`, 'warning');
                        return;
                    }

                    if (existingItem) {
                        existingItem.quantity += 1;
                    } else {
                        this.cart.push({ ...product, quantity: 1 });
                    }

                    this.searchQuery = '';
                    this.searchResults = [];
                    window.pharmaAnimations.showToast('Produit ajout√© au panier', 'success', 1500);
                },

                incrementQuantity(item) {
                    if (item.quantity >= item.current_stock) {
                        window.pharmaAnimations.showToast('Stock insuffisant!', 'warning');
                        return;
                    }
                    item.quantity += 1;
                },

                decrementQuantity(item) {
                    if (item.quantity > 1) {
                        item.quantity -= 1;
                    } else {
                        this.removeFromCart(item);
                    }
                },

                removeFromCart(item) {
                    this.cart = this.cart.filter(cartItem => cartItem.id !== item.id);
                },

                async clearCart() {
                    const confirmed = await window.pharmaAnimations.confirmDialog('Vider tout le panier?', 'Confirmation');
                    if (confirmed) {
                        this.cart = [];
                    }
                },

                async completeSale(paymentType) {
                    if (this.cart.length === 0) return;

                    let customerName = '';
                    if (paymentType === 'credit') {
                        customerName = prompt('Nom du client (cr√©dit):');
                        if (!customerName) return;
                    }

                    window.pharmaAnimations.LoadingSpinner.show();

                    const saleData = {
                        sale_type: paymentType,
                        customer_name: customerName,
                        cart: this.cart,
                        total_amount: this.total,
                        timestamp: new Date().toISOString()
                    };

                    try {
                        const response = await fetch('/api/sales/complete/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCookie('csrftoken')
                            },
                            body: JSON.stringify(saleData)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            window.pharmaAnimations.showToast(result.message, 'success');
                        } else {
                            throw new Error('Network offline');
                        }
                    } catch (error) {
                        if (window.offlineSales) {
                            const localSaleId = await window.offlineSales.saveSale(saleData);
                            window.pharmaAnimations.showToast(`Vente enregistr√©e localement! ID: ${localSaleId}`, 'success');
                        } else {
                            window.pharmaAnimations.showToast('Erreur lors de la vente', 'danger');
                        }
                    } finally {
                        window.pharmaAnimations.LoadingSpinner.hide();
                    }

                    this.cart = [];
                    this.searchQuery = '';
                    this.searchResults = [];
                },

                startScanner() {
                    this.showScanner = true;
                    this.scannerError = '';
                    this.$nextTick(() => {
                        setTimeout(() => this.initScanner(), 500);
                    });
                },

                stopScanner() {
                    if (this.isScanning && typeof Quagga !== 'undefined') {
                        Quagga.stop();
                        this.isScanning = false;
                    }
                    this.showScanner = false;
                },

                initScanner() {
                    if (typeof Quagga === 'undefined') {
                        this.scannerError = 'Scanner non disponible';
                        return;
                    }

                    if (!this.isScanning && this.showScanner) {
                        Quagga.init({
                            inputStream: {
                                name: "Live",
                                type: "LiveStream",
                                target: document.querySelector('#barcode-scanner'),
                                constraints: { width: 640, height: 480, facingMode: "environment" }
                            },
                            decoder: {
                                readers: ["code_128_reader", "ean_reader", "ean_8_reader", "upc_reader"]
                            }
                        }, (err) => {
                            if (err) {
                                this.scannerError = "Erreur: " + err;
                                return;
                            }
                            Quagga.start();
                            this.isScanning = true;
                        });

                        Quagga.onDetected((result) => {
                            const code = result.codeResult.code;
                            this.stopScanner();
                            this.searchByBarcode(code);
                        });
                    }
                },

                async searchByBarcode(barcode) {
                    try {
                        const response = await fetch(`/api/products/barcode-search/?barcode=${encodeURIComponent(barcode)}`);
                        const result = await response.json();

                        if (result.success) {
                            this.addToCart(result.product);
                        } else {
                            window.pharmaAnimations.showToast(result.message, 'danger');
                        }
                    } catch (error) {
                        window.pharmaAnimations.showToast('Erreur r√©seau', 'danger');
                    }
                },

                getCookie(name) {
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                },

                formatPrice(price) {
                    return new Intl.NumberFormat('fr-FR', {
                        style: 'currency',
                        currency: 'XOF',
                        minimumFractionDigits: 0
                    }).format(price);
                }
            }
        }
    </script>

    <!-- Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/js/service-worker.js')
                .then(() => console.log('‚úÖ Service Worker registered'))
                .catch(err => console.log('‚ùå Service Worker failed:', err));
        }
    </script>
</body>

</html>