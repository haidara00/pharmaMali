<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PharmaGestion - Historique des Ventes</title>

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Custom Design System -->
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">

    <!-- Alpine.js -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

    <style>
        .history-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-lg);
        }

        .history-header {
            background: linear-gradient(135deg, var(--color-success), var(--color-info));
            padding: var(--spacing-xl);
            border-radius: var(--radius-xl);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-xl), var(--shadow-glow-success);
        }

        .filter-pills {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
            margin-top: var(--spacing-md);
        }

        .filter-pill {
            padding: 0.625rem 1.25rem;
            border-radius: var(--radius-lg);
            background: var(--glass-bg);
            border: 2px solid var(--glass-border);
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-base);
            font-weight: 500;
        }

        .filter-pill.active {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-light));
            border-color: var(--color-primary);
            color: white;
            box-shadow: var(--shadow-glow-primary);
        }

        .filter-pill:hover:not(.active) {
            border-color: var(--color-primary);
            transform: translateY(-2px);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .sale-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            transition: all var(--transition-base);
        }

        .sale-card:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }

        .sale-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--glass-border);
        }

        .sale-items {
            margin-top: var(--spacing-md);
        }

        .sale-item {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid hsla(0, 0%, 100%, 0.05);
        }
    </style>
</head>

<body>
    <div class="history-container" x-data="salesHistoryApp()">
        <!-- Header -->
        <div class="history-header">
            <h1
                style="margin: 0; color: white; font-size: var(--text-3xl); display: flex; align-items: center; gap: var(--spacing-md);">
                <i class="bi bi-clock-history"></i>
                Historique des Ventes
            </h1>
            <div class="filter-pills">
                <template x-for="filter in filters" :key="filter.value">
                    <button class="filter-pill" :class="{ 'active': activeFilter === filter.value }"
                        @click="loadSales(filter.value)" x-text="filter.label"></button>
                </template>
            </div>
        </div>

        <!-- Summary Cards -->
        <div x-show="summary.total_sales > 0" class="summary-grid" style="display: none;">
            <div class="metric-card metric-card-success">
                <div class="icon"><i class="bi bi-cart-check"></i></div>
                <div class="value" x-text="summary.total_sales">0</div>
                <div class="label">Ventes Total</div>
            </div>

            <div class="metric-card metric-card-primary">
                <div class="icon"><i class="bi bi-currency-exchange"></i></div>
                <div class="value" x-text="formatPrice(summary.total_revenue)">0 FCFA</div>
                <div class="label">Chiffre d'Affaires</div>
            </div>

            <div class="metric-card metric-card-warning">
                <div class="icon"><i class="bi bi-calendar-range"></i></div>
                <div class="value" style="font-size: var(--text-lg);"
                    x-text="summary.date_range.start + ' - ' + summary.date_range.end">-</div>
                <div class="label">PÃ©riode</div>
            </div>
        </div>

        <!-- Sales List -->
        <div class="glass-card glass-card-lg">
            <h3 style="margin-bottom: var(--spacing-lg);">
                <i class="bi bi-list-ul"></i> DÃ©tail des Ventes
            </h3>

            <!-- Loading State -->
            <div x-show="loading" style="text-align: center; padding: var(--spacing-2xl);">
                <div class="spinner"></div>
            </div>

            <!-- Empty State -->
            <div x-show="!loading && sales.length === 0"
                style="text-align: center; padding: var(--spacing-2xl); color: var(--text-muted);">
                <i class="bi bi-inbox" style="font-size: 4rem; opacity: 0.3;"></i>
                <h5 style="margin-top: var(--spacing-md);">Aucune vente trouvÃ©e</h5>
                <p>Aucune vente pour cette pÃ©riode</p>
            </div>

            <!-- Sales List -->
            <div x-show="!loading && sales.length > 0" style="display: none;">
                <template x-for="sale in sales" :key="sale.id">
                    <div class="sale-card">
                        <div class="sale-header">
                            <div>
                                <strong style="font-size: var(--text-lg);" x-text="'Vente #' + sale.id"></strong>
                                <span class="badge-glow"
                                    :class="sale.sale_type === 'Comptant' ? 'badge-success' : 'badge-warning'"
                                    x-text="sale.sale_type" style="margin-left: var(--spacing-sm);"></span>
                                <span x-show="sale.customer_name" class="badge-glow badge-primary"
                                    x-text="'Client: ' + sale.customer_name"
                                    style="margin-left: var(--spacing-sm);"></span>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: var(--text-secondary); font-size: var(--text-sm);"
                                    x-text="sale.sale_date"></div>
                                <div style="font-size: var(--text-xl); font-weight: 700; font-family: var(--font-display); color: var(--color-success);"
                                    x-text="formatPrice(sale.total_amount)"></div>
                            </div>
                        </div>

                        <div class="sale-items">
                            <template x-for="item in sale.items" :key="item.product_name">
                                <div class="sale-item">
                                    <div>
                                        <span x-text="item.product_name"></span>
                                        <small style="color: var(--text-muted); margin-left: var(--spacing-sm);"
                                            x-text="'x' + item.quantity"></small>
                                    </div>
                                    <div>
                                        <span style="color: var(--text-secondary);"
                                            x-text="formatPrice(item.unit_price)"></span>
                                        <span style="color: var(--text-muted); margin: 0 var(--spacing-sm);">=</span>
                                        <strong x-text="formatPrice(item.total_price)"></strong>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Back Button -->
        <div style="margin-top: var(--spacing-xl); text-align: center;">
            <a href="/" class="btn-gradient btn-primary">
                <i class="bi bi-arrow-left"></i> Retour Ã  la Caisse
            </a>
        </div>
    </div>

    <!-- Footer -->
    <footer
        style="margin-top: var(--spacing-2xl); padding: var(--spacing-lg); text-align: center; border-top: 1px solid var(--glass-border);">
        <small style="color: var(--text-secondary);">
            Un produit <strong style="color: var(--color-primary);">HydaraSoft</strong> |
            DÃ©veloppÃ© par <strong>Ismail HAIDARA</strong> |
            ðŸ“ž <a href="tel:+22391550337">00223 91550337</a> |
            ðŸ“§ <a href="mailto:ihaidara852@gmail.com">ihaidara852@gmail.com</a>
        </small>
    </footer>

    <!-- Scripts -->
    <script src="{% static 'js/animations.js' %}"></script>
    <script src="/static/js/offline-sales.js"></script>
    <script src="/static/js/offline-data-loader.js"></script>

    <script>
        function salesHistoryApp() {
            return {
                loading: true,
                sales: [],
                summary: {
                    total_sales: 0,
                    total_revenue: 0,
                    date_range: { start: '', end: '' }
                },
                activeFilter: 'today',
                filters: [
                    { value: 'today', label: "Aujourd'hui" },
                    { value: 'week', label: "Cette Semaine" },
                    { value: 'month', label: "Ce Mois" },
                    { value: 'all', label: "Toutes" }
                ],

                async init() {
                    await this.loadSales('today');
                },

                async loadSales(filterType) {
                    this.loading = true;
                    this.activeFilter = filterType;

                    try {
                        const response = await fetch(`/api/sales/history/?filter=${filterType}`);
                        const data = await response.json();

                        this.sales = data.sales;
                        this.summary = {
                            total_sales: data.total_sales,
                            total_revenue: data.total_revenue,
                            date_range: data.date_range
                        };

                        this.$nextTick(() => {
                            // Animate summary values
                            const valueElements = document.querySelectorAll('.metric-card .value');
                            valueElements.forEach(el => {
                                const text = el.textContent;
                                if (!isNaN(parseInt(text))) {
                                    window.pharmaAnimations.countUp(el, parseInt(text), 1000);
                                }
                            });
                        });
                    } catch (error) {
                        console.error('Error loading sales:', error);
                        window.pharmaAnimations.showToast('Erreur lors du chargement des ventes', 'danger');
                    } finally {
                        this.loading = false;
                    }
                },

                formatPrice(price) {
                    return new Intl.NumberFormat('fr-FR', {
                        style: 'currency',
                        currency: 'XOF',
                        minimumFractionDigits: 0
                    }).format(price);
                }
            }
        }
    </script>

    <!-- Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/js/service-worker.js');
        }

        if (navigator.onLine && window.offlineDataLoader) {
            window.offlineDataLoader.loadAllData();
        }
    </script>
</body>

</html>